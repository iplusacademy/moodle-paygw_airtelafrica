{"version":3,"file":"gateways_modal.min.js","sources":["../src/gateways_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for Airtel Africa content in the gateways modal.\n *\n * @copyright  2023 Medical Access Uganda\n * @author     Renaat Debleu <info@eWallah.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Repository from './repository';\nimport Templates from 'core/templates';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Creates and shows a modal that contains a placeholder.\n *\n * @returns {Promise<Modal>}\n */\nconst showModalWithPlaceholder = async() => {\n    const modal = await ModalFactory.create({\n        body: await Templates.render('paygw_airtelafrica/placeholder', {})\n    });\n    modal.show();\n    return modal;\n};\n\n/**\n * Process the payment.\n *\n * @param {string} component Name of the component that the itemId belongs to\n * @param {string} paymentArea The area of the component that the itemId belongs to\n * @param {number} itemId An internal identifier that is used by the component\n * @param {string} description Description of the payment\n * @returns {Promise<string>}\n */\nexport const process = (component, paymentArea, itemId, description) => {\n    return Promise.all([\n        showModalWithPlaceholder(),\n        Repository.getConfigForJs(component, paymentArea, itemId),\n    ])\n    .then(([modal, airtelConfig]) => {\n        modal.setTitle(getString('pluginname', 'paygw_airtelafrica'));\n        const phoneNumber = modal.getRoot().find('#airtel-phone');\n        phoneNumber.append('<h4>' + airtelConfig.phone + '</h4>');\n        const userCountry = modal.getRoot().find('#airtel-country');\n        userCountry.append('<h4>' + airtelConfig.usercountry + '</h4>');\n        const extraDiv = modal.getRoot().find('#airtel-extra');\n        extraDiv.append('<h4>' + airtelConfig.cost + ' ' + airtelConfig.currency + '</h4>');\n        const payForm = modal.getRoot().find('#airtel-form');\n        payForm.append('<input type=\"hidden\" name=\"userid\" value=\"' + airtelConfig.userid + '\" />');\n        payForm.append('<input type=\"hidden\" name=\"phone\" value=\"' + airtelConfig.phone + '\" />');\n        payForm.append('<input type=\"hidden\" name=\"country\" value=\"' + airtelConfig.country + '\" />');\n        payForm.append('<input type=\"hidden\" name=\"component\" value=\"' + component + '\" />');\n        payForm.append('<input type=\"hidden\" name=\"paymentarea\" value=\"' + paymentArea + '\" />');\n        payForm.append('<input type=\"hidden\" name=\"itemid\" value=\"' + itemId + '\" />');\n        payForm.append('<input type=\"hidden\" name=\"description\" value=\"' + description + '\" />');\n        payForm.append('<input type=\"hidden\" name=\"reference\" value=\"' + airtelConfig.reference + '\" />');\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            // Destroy when hidden.\n            console.log('Destroy modal');  // eslint-disable-line\n            modal.destroy();\n        });\n\n        return Promise.all([modal, airtelConfig]);\n    })\n    .then(([modal, airtelConfig]) => {\n        const cancelButton = modal.getRoot().find('#airtel-cancel');\n        cancelButton.on('click', function() {\n            modal.destroy();\n        });\n        const payButton = modal.getRoot().find('#airtel-pay');\n        payButton.removeAttr('disabled');\n        payButton.on('click', function(e) {\n            e.preventDefault();\n            modal.setBody(Templates.render('paygw_airtelafrica/busy', {}));\n\n            return Promise.all([\n                Repository.transactionStart(component, paymentArea, itemId,\n                                            airtelConfig.reference, airtelConfig.phone, airtelConfig.country),\n            ])\n            .then(([airtelPay]) => {\n                const cancelButton1 = modal.getRoot().find('#airtel-cancel');\n                cancelButton1.on('click', function() {\n                    modal.destroy();\n                });\n                if (airtelPay.transactionid > 0) {\n                    console.log('Airtel Africa payment process started');  // eslint-disable-line\n                    console.log('TransactionId: ' + airtelPay.transactionid);  // eslint-disable-line\n                    console.log('Token: ' + airtelPay.token);  // eslint-disable-line\n                    const outDiv = modal.getRoot().find('#airtel-out');\n                    const spinnerDiv = modal.getRoot().find('#airtel-spinner');\n                    outDiv.append('<h4>TransactionId: ' + airtelPay.transactionid + '</h4>');\n                    var arrayints = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];\n                    var interval = 20000;\n                    var tip = 'TIP';\n                    const b = '</div>';\n                    const progressDiv = modal.getRoot().find('#airtel-progress_bar');\n                    arrayints.forEach(function(el, index) {\n                        setTimeout(function() {\n                            progressDiv.attr('value', el * 10);\n                            if (airtelPay.transactionid > 0) {\n                                if (tip == 'TIP') {\n                                    modal.setFooter('Step ' + el + '/10');\n                                    Promise.all([\n                                        Repository.transactionComplete(\n                                            component, paymentArea, itemId, airtelPay.transactionid, airtelConfig.userid, el),\n                                    ])\n                                    .then(([airtelPing]) => {\n                                        modal.setFooter(airtelPing.message);\n                                        console.log(airtelPing.message);  // eslint-disable-line\n                                        if (airtelPing.message == 'Transaction failed') {\n                                            tip = 'TF';\n                                            const a = '<br/><div class=\"p-3 mb-2 bg-danger text-white font-weight-bold\">';\n                                            outDiv.append(a + airtelPing.message + b);\n                                            spinnerDiv.attr('style', 'display: none;');\n                                            return;\n                                        }\n                                        if (airtelPing.success == true) {\n                                            tip = 'TS';\n                                            const a = '<br/><div class=\"p-3 mb-2 text-success font-weight-bold\">';\n                                            outDiv.append(a + airtelPing.message + b);\n                                            spinnerDiv.attr('display', 'hidden');\n                                            const payButton1 = modal.getRoot().find('#airtel-pay');\n                                            payButton1.removeAttr('disabled');\n                                            payButton1.on('click', function() {\n                                                modal.destroy();\n                                            });\n                                            spinnerDiv.attr('style', 'display: none;');\n                                            cancelButton1.attr('style', 'display: none;');\n                                            return;\n                                        }\n                                    });\n                                }\n                                if (el == 10) {\n                                    modal.destroy();\n                                }\n                            }\n                        }, index * interval);\n                    });\n                } else {\n                    console.log('Airtel Africa transaction FAILED');  // eslint-disable-line\n                    modal.setFooter('FAILED');\n                }\n            }).catch(e => {\n                // We want to use promise reject here - as that's what core payment stuff expects.\n                console.log('Airtel Africa payment rejected');  // eslint-disable-line\n                return Promise.reject(e.message);\n            });\n        });\n        return new Promise(() => null);\n    }).catch(e => {\n        return Promise.reject(e.message);\n    });\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","Repository","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_interopRequireWildcard","_templates","_modal_factory","_modal_events","showModalWithPlaceholder","async","modal","ModalFactory","create","body","Templates","render","show","_exports","process","component","paymentArea","itemId","description","Promise","all","getConfigForJs","then","_ref","airtelConfig","setTitle","getString","getRoot","find","append","phone","usercountry","cost","currency","payForm","userid","country","reference","on","ModalEvents","hidden","console","log","destroy","_ref2","payButton","removeAttr","e","preventDefault","setBody","transactionStart","_ref3","airtelPay","cancelButton1","transactionid","token","outDiv","spinnerDiv","tip","b","progressDiv","forEach","el","index","setTimeout","attr","setFooter","transactionComplete","_ref4","airtelPing","message","a","success","payButton1","catch","reject"],"mappings":"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"}