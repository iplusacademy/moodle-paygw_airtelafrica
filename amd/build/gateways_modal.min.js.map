{"version":3,"file":"gateways_modal.min.js","sources":["../src/gateways_modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for Airtel Africa content in the gateways modal.\n *\n * @copyright  2023 Medical Access Uganda\n * @author     Renaat Debleu <info@eWallah.net>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Repository from './repository';\nimport Ajax from 'core/ajax';\nimport Config from 'core/config';\nimport Log from 'core/log';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Templates from 'core/templates';\nimport {get_string as getString} from 'core/str';\n\n/**\n * Creates and shows a modal that contains a placeholder.\n *\n * @returns {Promise<Modal>}\n */\nconst showModalWithPlaceholder = async() => {\n    const modal = await ModalFactory.create({\n        body: await Templates.render('paygw_airtelafrica/placeholder', {})\n    });\n    modal.show();\n    return modal;\n};\n\n/**\n * Process the payment.\n *\n * @param {string} component Name of the component that the itemId belongs to\n * @param {string} paymentArea The area of the component that the itemId belongs to\n * @param {number} itemId An internal identifier that is used by the component\n * @param {string} description Description of the payment\n * @returns {Promise<string>}\n */\nexport const process = (component, paymentArea, itemId, description) => {\n    return Promise.all([\n        showModalWithPlaceholder(),\n        Repository.getConfigForJs(component, paymentArea, itemId),\n    ])\n    .then(([modal, airtelConfig]) => {\n        modal.setTitle(getString('pluginname', 'paygw_airtelafrica'));\n        const phoneNumber = modal.getRoot().find('#airtel-phone');\n        phoneNumber.append('<h4>' + airtelConfig.phone + '</h4>');\n        const userCountry = modal.getRoot().find('#airtel-country');\n        userCountry.append('<h4>' + airtelConfig.usercountry + '</h4>');\n        const extraDiv = modal.getRoot().find('#airtel-extra');\n        extraDiv.append('<h4>' + airtelConfig.cost + ' ' + airtelConfig.currency + '</h4>');\n        modal.getRoot().on(ModalEvents.hidden, () => {\n            // Destroy when hidden.\n            console.log('Destroy modal');    // eslint-disable-line\n            modal.destroy();\n        });\n\n        return Promise.all([modal, airtelConfig]);\n    })\n    .then(([modal, airtelConfig]) => {\n        const cancelButton = modal.getRoot().find('#airtel-cancel');\n        cancelButton.on('click', function() {\n            modal.destroy();\n        });\n        const payButton = modal.getRoot().find('#airtel-pay');\n        payButton.removeAttr('disabled');\n        payButton.on('click', function(e) {\n            e.preventDefault();\n            modal.setBody(Templates.render('paygw_airtelafrica/busy', {\n                \"sesskey\": Config.sesskey,\n                \"phone\": airtelConfig.phone,\n                \"country\": airtelConfig.country,\n                \"component\": component,\n                \"paymentarea\": paymentArea,\n                \"transactionid\": \"0\",\n                \"itemid\": itemId,\n                \"description\": description,\n                \"reference\": airtelConfig.reference,\n            }));\n            const cancelButton = modal.getRoot().find('#airtel-cancel');\n            cancelButton.on('click', function() {\n                e.preventDefault();\n                modal.destroy();\n            });\n            const payButton = modal.getRoot().find('#airtel-pay');\n            payButton.on('click', function() {\n                modal.destroy();\n            });\n            Promise.all([\n                Repository.transactionStart(component, paymentArea, itemId),\n            ])\n            .then(([airtelPay]) => {\n                const cancelButton1 = modal.getRoot().find('#airtel-cancel');\n                cancelButton1.on('click', function() {\n                    e.preventDefault();\n                    modal.destroy();\n                });\n                const payButton = modal.getRoot().find('#airtel-pay');\n                payButton.on('click', function() {\n                    modal.destroy();\n                });\n                const transId = airtelPay.transactionid;\n                const currency = airtelConfig.currency;\n                modal.setBody(Templates.render('paygw_airtelafrica/busy', {\n                    \"sesskey\": Config.sesskey,\n                    \"phone\": airtelConfig.phone,\n                    \"country\": airtelConfig.country,\n                    \"component\": component,\n                    \"paymentarea\": paymentArea,\n                    \"transactionid\": transId,\n                    \"itemid\": itemId,\n                    \"description\": description,\n                    \"reference\": airtelConfig.reference,\n                }));\n                if ( transId != '0') {\n                    modal.setFooter('Step 0/10');\n                    console.log('Airtel Africa payment process started');  // eslint-disable-line\n                    console.log('Transaction id: ' + transId);  // eslint-disable-line\n                    const outDiv = modal.getRoot().find('#airtel-out');\n                    outDiv.append('<h4>Transaction id: ' + transId + '</h4>');\n                    var arrayints = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];\n                    var interval = airtelConfig.timeout;\n                    const b = '</div>';\n                    arrayints.forEach(function(el, index) {\n                        setTimeout(function() {\n                            const progressDiv = modal.getRoot().find('#airtel-progress_bar');\n                            progressDiv.attr('value', el * 10);\n                            if (transId != '') {\n                                modal.setFooter('Step ' + el + '/10');\n                                Ajax.call([{\n                                    methodname: \"paygw_airtelafrica_transaction_complete\",\n                                    args: {\n                                        component,\n                                        paymentArea,\n                                        itemId,\n                                        transId,\n                                        currency,\n                                    },\n                                    done: function(airtelPing) {\n                                        var tmp = transId + ' ' + airtelPing.success;\n                                        modal.setFooter('Step ' + el + '/10');\n                                        console.log(tmp + ' Step ' + el + '/10');  // eslint-disable-line\n                                        console.log(airtelPing.message);  // eslint-disable-line\n                                        const spinnerDiv = modal.getRoot().find('#airtel-spinner');\n                                        if (airtelPing.message == 'Transaction failed') {\n                                            const a = '<br/><div class=\"p-3 mb-2 bg-danger text-white font-weight-bold\">';\n                                            outDiv.append(a + airtelPing.message + b);\n                                            spinnerDiv.attr('style', 'display: none;');\n                                            return Promise.reject();\n                                        }\n                                        if (airtelPing.success == true) {\n                                            el = 10;\n                                            const a = '<br/><div class=\"p-3 mb-2 text-success font-weight-bold\">';\n                                            outDiv.append(a + airtelPing.message + b);\n                                            spinnerDiv.attr('display', 'hidden');\n                                            const payButton1 = modal.getRoot().find('#airtel-pay');\n                                            payButton1.removeAttr('disabled');\n                                            payButton1.on('click', function() {\n                                                modal.destroy();\n                                            });\n                                            spinnerDiv.attr('style', 'display: none;');\n                                            cancelButton1.attr('style', 'display: none;');\n                                            payButton.removeAttr('disabled');\n                                            return new Promise(() => null);\n                                        }\n                                    }\n                                }]);\n                                if (el > 9) {\n                                    modal.destroy();\n                                }\n                            }\n                        }, index * interval);\n                    });\n                    return new Promise(() => null);\n                } else {\n                    console.log('Airtel Africa transaction FAILED');  // eslint-disable-line\n                    Log.debug('Airtel Africa transaction FAILED');\n                    Log.debug(e);\n                }\n            }).catch(e => {\n                // We want to use promise reject here - as that's what core payment stuff expects.\n                console.log('Airtel Africa payment rejected');  // eslint-disable-line\n                Log.debug('Airtel Africa payment rejected');\n                Log.debug(e);\n            });\n        });\n        return new Promise(() => null);\n    }).catch(e => {\n        Log.debug('Global error.');\n        Log.debug(e);\n        return Promise.reject();\n    });\n};\n"],"names":["showModalWithPlaceholder","ModalFactory","Templates","render","body","create","modal","show","component","paymentArea","itemId","description","Promise","all","Repository","getConfigForJs","then","airtelConfig","setTitle","getRoot","find","append","phone","usercountry","cost","currency","on","ModalEvents","hidden","console","log","destroy","payButton","removeAttr","e","preventDefault","setBody","Config","sesskey","country","reference","transactionStart","airtelPay","cancelButton1","transId","transactionid","setFooter","outDiv","interval","timeout","b","forEach","el","index","setTimeout","attr","call","methodname","args","done","airtelPing","tmp","success","message","spinnerDiv","reject","payButton1","debug","catch"],"mappings":"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"}