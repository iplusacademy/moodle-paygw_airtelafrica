define("paygw_airtelafrica/gateways_modal",["exports","./repository","core/ajax","core/config","core/log","core/modal_factory","core/modal_events","core/templates","core/str"],(function(_exports,Repository,_ajax,_config,_log,_modal_factory,_modal_events,_templates,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.process=void 0,Repository=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}
/**
   * This module is responsible for Airtel Africa content in the gateways modal.
   *
   * @copyright  2023 Medical Access Uganda Limited
   * @author     Renaat Debleu <info@eWallah.net>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */(Repository),_ajax=_interopRequireDefault(_ajax),_config=_interopRequireDefault(_config),_log=_interopRequireDefault(_log),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_templates=_interopRequireDefault(_templates);const showModalWithPlaceholder=async()=>{const modal=await _modal_factory.default.create({body:await _templates.default.render("paygw_airtelafrica/placeholder",{})});return modal.show(),modal};_exports.process=(component,paymentArea,itemId,description)=>Promise.all([showModalWithPlaceholder(),Repository.getConfigForJs(component,paymentArea,itemId)]).then((_ref=>{let[modal,airtelConfig]=_ref;modal.setTitle((0,_str.get_string)("pluginname","paygw_airtelafrica")),console.log(description);modal.getRoot().find("#airtel-phone").append("<h4>"+airtelConfig.phone+"</h4>");modal.getRoot().find("#airtel-country").append("<h4>"+airtelConfig.usercountry+"</h4>");return modal.getRoot().find("#airtel-extra").append("<h4>"+airtelConfig.cost+" "+airtelConfig.currency+"</h4>"),modal.getRoot().on(_modal_events.default.hidden,(()=>{console.log("Destroy modal"),modal.destroy()})),Promise.all([modal,airtelConfig])})).then((_ref2=>{let[modal,airtelConfig]=_ref2;var cancelButton=modal.getRoot().find("#airtel-cancel");cancelButton.on("click",(function(){modal.destroy()}));var payButton=modal.getRoot().find("#airtel-pay");return payButton.removeAttr("disabled"),payButton.on("click",(function(e){e.preventDefault(),Promise.all([Repository.transactionStart(component,paymentArea,itemId)]).then((_ref3=>{let[airtelPay]=_ref3;const transId=airtelPay.transactionid;modal.setBody(_templates.default.render("paygw_airtelafrica/busy",{sesskey:_config.default.sesskey,phone:airtelConfig.phone,country:airtelConfig.country,component:component,paymentarea:paymentArea,transactionid:transId,itemid:itemId,description:description,reference:airtelConfig.reference})),(cancelButton=modal.getRoot().find("#airtel-cancel")).on("click",(function(){e.preventDefault(),modal.destroy()})),(payButton=modal.getRoot().find("#airtel-pay")).on("click",(function(){e.preventDefault()})),console.log("Airtel Africa payment process started"),console.log("Transaction id: "+transId);var interval=airtelConfig.timeout,cont=!0;const b="</div>";return[1,2,3,4,5,6,7,8,9,10].forEach((function(el,index){setTimeout((function(){if(1==cont){var progressDiv=modal.getRoot().find("#airtel-progress_bar");progressDiv.attr("value",10*el),""!=transId&&(_ajax.default.call([{methodname:"paygw_airtelafrica_transaction_complete",args:{component:component,paymentarea:paymentArea,itemid:itemId,transactionid:transId},done:function(airtelPing){if(modal.setFooter(el+"/10"),console.log(el+"/10 "+airtelPing.message),"Transaction Success"==airtelPing.message){cont=!1;modal.getRoot().find("#airtel-pay").on("click",(function(){const loc=window.location.href;window.location.replace(loc)})),progressDiv.attr("value",100),modal.setFooter("Transaction with id "+transId+" succeeded");modal.getRoot().find("#airtel-spinner").attr("style","display: none;");const a='<br/><div class="p-3 mb-2 text-success font-weight-bold">';modal.getRoot().find("#airtel-out").append(a+airtelPing.message+b)}if("Transaction Failed"==airtelPing.message){cont=!1;const a='<br/><div class="p-3 mb-2 bg-danger text-white font-weight-bold">';modal.setBody(a+airtelPing.message+b),modal.setFooter("Transaction with id "+transId+" failed")}},fail:function(e){console.log((0,_str.get_string)("failed","paygw_airtelafrica")),_log.default.debug(e)}}]),el>9&&modal.destroy())}}),index*interval)})),new Promise((()=>null))})).catch((e=>{modal.setBody((0,_str.get_string)("unable","paygw_airtelafrica")),console.log("Airtel Africa payment rejected"),_log.default.debug("Airtel Africa payment rejected"),_log.default.debug(e)}))})),new Promise((()=>null))})).catch((e=>(_log.default.debug("Global error."),_log.default.debug(e),Promise.reject(e.message))))}));

//# sourceMappingURL=gateways_modal.min.js.map