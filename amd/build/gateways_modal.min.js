define("paygw_airtelafrica/gateways_modal",["exports","./repository","core/templates","core/modal_factory","core/modal_events"],(function(_exports,Repository,_templates,_modal_factory,_modal_events){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.process=void 0,Repository=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}
/**
   * This module is responsible for Airtel Africa content in the gateways modal.
   *
   * @copyright  2023 Medical Access Uganda
   * @author     Renaat Debleu <info@eWallah.net>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */(Repository),_templates=_interopRequireDefault(_templates),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events);const showModalWithPlaceholder=async()=>{const modal=await _modal_factory.default.create({body:await _templates.default.render("paygw_airtelafrica/placeholder",{})});return modal.show(),modal};_exports.process=(component,paymentArea,itemId,description)=>Promise.all([showModalWithPlaceholder(),Repository.getConfigForJs(component,paymentArea,itemId)]).then((_ref=>{let[modal,airtelConfig]=_ref;modal.setTitle("Airtel Africa");modal.getRoot().find("#airtel-phone").append("<h4>"+airtelConfig.phone+"</h4>");modal.getRoot().find("#airtel-country").append("<h4>"+airtelConfig.usercountry+"</h4>");modal.getRoot().find("#airtel-extra").append("<h4>"+airtelConfig.cost+" "+airtelConfig.currency+"</h4>");const payForm=modal.getRoot().find("#airtel-form");return payForm.append('<input type="hidden" name="userid" value="'+airtelConfig.userid+'" />'),payForm.append('<input type="hidden" name="phone" value="'+airtelConfig.phone+'" />'),payForm.append('<input type="hidden" name="country" value="'+airtelConfig.country+'" />'),payForm.append('<input type="hidden" name="component" value="'+component+'" />'),payForm.append('<input type="hidden" name="paymentarea" value="'+paymentArea+'" />'),payForm.append('<input type="hidden" name="itemid" value="'+itemId+'" />'),payForm.append('<input type="hidden" name="description" value="'+description+'" />'),payForm.append('<input type="hidden" name="reference" value="'+airtelConfig.reference+'" />'),modal.getRoot().on(_modal_events.default.hidden,(()=>{console.log("Destroy modal"),modal.destroy()})),Promise.all([modal,airtelConfig])})).then((_ref2=>{let[modal,airtelConfig]=_ref2;modal.getRoot().find("#airtel-cancel").on("click",(function(){modal.destroy()}));const payButton=modal.getRoot().find("#airtel-pay");return payButton.removeAttr("disabled"),payButton.on("click",(function(e){return e.preventDefault(),modal.setBody(_templates.default.render("paygw_airtelafrica/busy",{})),Promise.all([Repository.transactionStart(component,paymentArea,itemId,airtelConfig.reference,airtelConfig.phone,airtelConfig.country)]).then((_ref3=>{let[airtelPay]=_ref3;const cancelButton1=modal.getRoot().find("#airtel-cancel");if(cancelButton1.on("click",(function(){modal.destroy()})),airtelPay.transactionid>0){console.log("Airtel Africa payment process started"),console.log("TransactionId: "+airtelPay.transactionid),console.log("Token: "+airtelPay.token);const outDiv=modal.getRoot().find("#airtel-out"),spinnerDiv=modal.getRoot().find("#airtel-spinner");outDiv.append("<h4>TransactionId: "+airtelPay.transactionid+"</h4>");var tip="TIP";const b="</div>",progressDiv=modal.getRoot().find("#airtel-progress_bar");[1,2,3,4,5,6,7,8,9,10].forEach((function(el,index){setTimeout((function(){progressDiv.attr("value",10*el),airtelPay.transactionid>0&&("TIP"==tip&&(modal.setFooter("Step "+el+"/10"),Promise.all([Repository.transactionComplete(component,paymentArea,itemId,airtelPay.transactionid,airtelConfig.userid,el)]).then((_ref4=>{let[airtelPing]=_ref4;if(modal.setFooter(airtelPing.message),console.log(airtelPing.message),"Transaction failed"==airtelPing.message){tip="TF";const a='<br/><div class="p-3 mb-2 bg-danger text-white font-weight-bold">';return outDiv.append(a+airtelPing.message+b),void spinnerDiv.attr("style","display: none;")}if(1==airtelPing.success){tip="TS";const a='<br/><div class="p-3 mb-2 text-success font-weight-bold">';outDiv.append(a+airtelPing.message+b),spinnerDiv.attr("display","hidden");const payButton1=modal.getRoot().find("#airtel-pay");return payButton1.removeAttr("disabled"),payButton1.on("click",(function(){modal.destroy()})),spinnerDiv.attr("style","display: none;"),void cancelButton1.attr("style","display: none;")}}))),10==el&&modal.destroy())}),2e4*index)}))}else console.log("Airtel Africa transaction FAILED"),modal.setFooter("FAILED")})).catch((e=>(console.log("Airtel Africa payment rejected"),Promise.reject(e.message))))})),new Promise((()=>null))})).catch((e=>Promise.reject(e.message)))}));

//# sourceMappingURL=gateways_modal.min.js.map